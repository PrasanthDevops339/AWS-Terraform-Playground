# ============================================================================
# GITLAB CI/CD PIPELINE - AMI GOVERNANCE
# ============================================================================
# Automated pipeline for AMI governance policy deployment
# Validates, plans, and applies Terraform changes

variables:
  TF_VERSION: "1.6.0"                    # Terraform version to use
  TF_ROOT: "${CI_PROJECT_DIR}/environments/prd"  # Working directory
  AWS_REGION: "us-east-1"                # Default AWS region

# Pipeline stages
stages:
  - validate    # Syntax and configuration validation
  - plan        # Terraform plan (dry-run)
  - apply       # Terraform apply (deployment)

# ============================================================================
# STAGE 1: VALIDATION
# ============================================================================
# Validate Terraform configuration syntax and formatting

validate:
  stage: validate
  image:
    name: hashicorp/terraform:${TF_VERSION}  # Official Terraform Docker image
    entrypoint: [""]                         # Override entrypoint
  script:
    - cd ${TF_ROOT}
    - terraform --version                     # Show Terraform version
    - terraform init -backend=false           # Initialize without backend (validation only)
    - terraform validate                      # Validate configuration
    - terraform fmt -check -recursive         # Check formatting
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # Run on MRs
    - if: '$CI_COMMIT_BRANCH == "main"'                   # Run on main branch
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'           # Run on feature branches
  tags:
    - docker

# ============================================================================
# STAGE 2: PLAN
# ============================================================================
# Generate Terraform execution plan for review

plan:
  stage: plan
  image:
    name: hashicorp/terraform:${TF_VERSION}
    entrypoint: [""]
  script:
    - cd ${TF_ROOT}
    - terraform --version
    - terraform init                          # Initialize Terraform
    - terraform plan -out=tfplan              # Generate plan file
    - terraform show -no-color tfplan > plan.txt  # Save plan output
  artifacts:
    name: "terraform-plan-${CI_COMMIT_REF_SLUG}"
    paths:
      - ${TF_ROOT}/tfplan                     # Save plan file
      - ${TF_ROOT}/plan.txt                   # Save human-readable plan
    expire_in: 1 week                         # Keep for 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
  tags:
    - docker

# ============================================================================
# STAGE 3: APPLY (PRODUCTION)
# ============================================================================
# Apply Terraform changes to production environment
# Requires manual approval for safety

apply:prd:
  stage: apply
  image:
    name: hashicorp/terraform:${TF_VERSION}
    entrypoint: [""]
  script:
    - cd ${TF_ROOT}
    - terraform --version
    - terraform init                          # Initialize Terraform
    - terraform apply -auto-approve           # Apply changes
  dependencies:
    - plan                                    # Depends on plan stage
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'       # Only on main branch
      when: manual                            # Require manual trigger
  environment:
    name: production                          # GitLab environment tracking
    action: start
  tags:
    - docker

# ============================================================================
# OPTIONAL: DESTROY (EMERGENCY USE ONLY)
# ============================================================================
# Destroy Terraform-managed resources
# Requires manual trigger and confirmation

destroy:prd:
  stage: apply
  image:
    name: hashicorp/terraform:${TF_VERSION}
    entrypoint: [""]
  script:
    - cd ${TF_ROOT}
    - terraform --version
    - terraform init
    - terraform destroy -auto-approve         # Destroy resources
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual                            # Manual trigger only
      allow_failure: false                    # Must succeed
  environment:
    name: production
    action: stop                              # Stop environment
  tags:
    - docker
