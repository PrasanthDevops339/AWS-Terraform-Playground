name: AMI Exception Expiry Check

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
  pull_request:
    paths:
      - 'terraform-module/variables.tf'
      - 'terraform-module/main.tf'

jobs:
  check-exceptions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Check for expired exceptions
        id: check
        run: |
          cd scripts
          python3 exception_manager.py --check --days 14
        continue-on-error: true
      
      - name: Send notification
        if: steps.check.outcome == 'failure'
        run: |
          python3 scripts/exception_manager.py \
            --check \
            --days 14 \
            --notify ${{ secrets.SNS_TOPIC_ARN }}
      
      - name: Create issue for expired exceptions
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ AMI Policy Exceptions Expired',
              body: `## Expired AMI Policy Exceptions Found

Automated check detected expired exception accounts in the AMI governance policy.

### Action Required:
1. Review the expired accounts
2. Update \`terraform-module/variables.tf\`
3. Remove expired entries from \`exception_accounts\` map
4. Run \`terraform plan\` to verify
5. Submit PR for approval

### Details:
See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for specific accounts.

### Documentation:
- [AMI Governance Runbook](runbooks/EXCEPTION-PROCESS.md)
- [Exception Request Process](runbooks/EXCEPTION-PROCESS.md#requesting-an-exception)

cc: @platform-team`,
              labels: ['ami-governance', 'expired-exception', 'action-required']
            })
      
      - name: Fail if exceptions expired
        if: steps.check.outcome == 'failure'
        run: |
          echo "::error::Expired AMI policy exceptions found. Please update variables.tf"
          exit 1
